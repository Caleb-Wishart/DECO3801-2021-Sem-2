{% extends 'base.html' %}

{% block style %}

<style>
    .clickedUp {
        fill: #2e9cfa;
    }
    .clickedDown{
        fill: #ff4545;
    }

</style>


{% endblock %}

{% block script %}

<script type="text/template" id="commentreply">
    <div class="row" id="commentReply">
        <!-- New Comment Reply -->
        <div class="col-1" style="border-right: 1px dashed #333;">
        </div>
        <div class="col-1" align="center">
            <img class="avatar" src="{{url_for('static',filename=current_user.avatar_link)}}" , alt="Profile Icon">
        </div>
        <div class="col">
            <div class="row">
                <p class="h6"><strong>{{current_user.username}}</strong></p>
            </div>
            <div class="row">
                <textarea name="reply_text" class="form-control" id="reply_input" rows="4" style="background: rgb(255, 255, 255) none repeat scroll 0% 0%; height: 16px;" placeholder="Leave a comment"></textarea>
                <div class = "d-flex justify-content-end">
                    <input type="submit" form="comment_form" value="Post Comment" class="btn btn-primary btn-sm" style="margin-right: 1rem!important;" onclick='sendReply(<%= cid %>)'></input>
                    <button type="Button" class="btn btn-outline-primary btn-sm" onclick='document.getElementById("reply_input").value = "";'>Clear</button>
                    <button type="Button" class="btn btn-outline-primary btn-sm" onclick='$( "#commentReply" ).remove();'>Cancel</button>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/template" id="comment_card">
     <% _.each(data,  function(comm) { %>
            <!-- Resource Comment -->
            <div class="card-body" name="comment">
                <div class="row" style="background-color:  #eeeeee ;">
                    <hr>
                    <div class="col-1" align="center">
                        <img class="avatar" src="{{url_for('static',filename='')}}/<%= comm.author.avatar_link %>" , alt="Profile Icon">
                    </div>
                    <div class="col">
                        <div class="row">
                            <p class="h6"><strong><%= comm.author.username %></strong></p>
                        </div>
                        <div class="row">
                            <div class="d-flex justify-content-between">
                                <p><small> <%= comm.comment.comment %></small></p>
                                <div>
                                    {% if current_user.is_authenticated %}
                                    <button class="badge rounded-pill bg-other-tag float-end" onclick='addReply(this,<%= comm.resource_comment_id %>)'>Reply</button>
                                    {% endif %}
                                    <% if (comm.author.username == username) { %>
                                        <button class="badge rounded-pill bg-year-tag float-end" onclick='this.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.innerHTML = "";'>Delete</button>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <% _.each(comm.replies,  function(reply) { %>
                <!-- Comment Reply -->
                <div class="row">
                    <div class="col-1" style="border-right: 1px dashed #333;">
                    </div>
                    <div class="col-1" align="center">
                        <img class="avatar" src="{{url_for('static',filename='')}}<%= reply.author.avatar_link %>" , alt="Profile Icon">
                    </div>
                    <div class="col">
                        <div class="row">
                            <p class="h6"><strong><%= reply.author.username %></strong></p>
                        </div>
                        <div class="row">
                            <div class="d-flex justify-content-between">
                                <p><small><%= reply.reply.reply %></small></p>
                                <div>
                                    <% if (reply.author.username == username) { %>
                                        <button class="badge rounded-pill bg-year-tag float-end" onclick='this.parentNode.parentNode.parentNode.parentNode.parentNode.innerHTML = "";'>Delete</button>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <% }); %>
            </div>
            <% }); %>
</script>

<script>
    // Voting
    function upvote() {
        voteAJAX(1,0);
    }
    function downvote() {
        voteAJAX(0,1);
    }

    function voteAJAX(up,down) {
        $.ajax(
            {
                type: "GET",
                url: "{{url_for('resourceVote')}}",
                data: { "rid": {{rid}} , "up": up, "down": down},
                success: function (response) {
                    $("#upvoteCount").text(response['up']); // set new results
                    $("#downvoteCount").text(response['down']); // set new results
                }
            }
        )
    }
    function addReply(node,cid){
        if ( $( "#commentReply" ).length ) {
            $( "#commentReply" ).remove();
        }

        var reply = _.template($("#commentreply").html());
        $(node).parents().filter(function() {
            return this.getAttribute("name") == "comment";
        })[0].innerHTML += reply({ cid: cid });
        document.getElementById("comment_input").value = "";
        document.getElementById("commentReply").scrollIntoView();
    }
    function sendReply(cid){
        $.ajax(
            {
                type: "GET",
                url: "{{url_for('resourceComment')}}",
                data: { "rid": {{rid}}, "type": "reply", "text": $('textarea[name=reply_text]').val().toLowerCase(), "cid": cid},
                success: function (response) {
                    updateResponse(response);
                }
            }
        )
        if ( $( "#commentReply" ).length ) {
            $( "#commentReply" ).remove();
        }
    }
    // add a comment to a resource
    function addComment(){
        $("#newComment").attr("hidden",true) ;
        $.ajax(
            {
                type: "GET",
                url: "{{url_for('resourceComment')}}",
                data: { "rid": {{rid}}, "type": "comment", "text": $('textarea[name=comment_text]').val().toLowerCase()},
                success: function (response) {
                    updateResponse(response);
                }
            }
        )
        document.getElementById("comment_input").value = "";
    }

    // update with the response
    function updateResponse(response){
        console.log(response);
        $("#result").empty(); // remove current results
        var resource_card = _.template($("#comment_card").html());
        $("#result").html(resource_card({ data: response, username: "{{current_user.username}}" })); // set new results
        if (response.length == 0) {
            $("#result").html('<div></div><div class="text-center"><p class="h2 text-muted">No Results</p></div>');
        }
    }

    // get the resource comments
    function commentAJAX() {
        $.ajax(
            {
                type: "GET",
                url: "{{url_for('resourceComment')}}",
                data: { "rid": {{rid}}},
                success: function (response) {
                    updateResponse(response);

                }
            }
        )
    }
    // Seed Document
    $(document).ready(function () {
        commentAJAX();
    });

    function editButtonFunc() {
        $("#editButton").attr("hidden",true) ;
        $("#saveButton").attr("hidden",false) ;
        $("#editing").attr("hidden",false) ;

        $("#resTitle").attr("contenteditable",true) ;
        $("#resDesc").attr("contenteditable",true) ;

        $("#resTitle").css("background-color","rgb(254, 239, 255)") ;
        $("#resDesc").css("background-color","rgb(254, 239, 255)") ;
        $("#abcEdit").css("background-color","rgb(254, 239, 255)") ;
    }

    function saveButtonFunc() {
        $("#editButton").attr("hidden",false) ;
        $("#saveButton").attr("hidden",true) ;
        $("#editing").attr("hidden",true) ;

        $("#resTitle").attr("contenteditable",false) ;
        $("#resDesc").attr("contenteditable",false) ;
        $("#resTitle").css("background-color",'') ;
        $("#resDesc").css("background-color",'') ;
        $("#abcEdit").css("background-color",'') ;
    }
</script>
{% endblock %}


{% block content %}
<div class="container" style="margin-top: 1rem;">
    <div class="row p-3" id="editing" hidden>
        <div class="d-flex justify-content-center h3 bg-warning p-1"> You are editing this page </div>
    </div>
    <!-- Top row with thumbnail and side bar -->
    <div class="row p-3">
        <!-- Resource Thumbnail -->
        <div class="col d-flex" style="padding-left: 0px!important">
            <div class="card">
                <img src="{{url_for('static', filename=banner.thumbnail_link)}}" , alt="Resource image" , width="900" ,
                    height="275">
            </div>
        </div>
    <!-- Top row right hand side -->
        <div class="col-3" align="center">
            <div class="card flex-fill">
                <p style="margin-top: 1.5rem!important;"> <strong> Information</strong></p>
                <p style="margin-top: 1.5rem!important;"><strong>Subject: </strong>
                    <span class="badge rounded-pill bg-subject-tag">
                            {{enum_to_website_output(subject)}}
                    </span>
                </p>
                <p style="margin-top: 1.5rem!important;"><strong>Year Level: </strong>
                    <span class="badge rounded-pill bg-year-tag">
                            {{enum_to_website_output(grade)}}
                    </span>
                </p>
                <div class = "col text-center" style="margin-top: 1.5rem!important; margin-bottom: 1.5rem!important;">
                    <a class="btn btn-primary" style = "width: 60%"
                    {% if res.resource_link.startswith('resource/') %}
                        href="{{url_for('static', filename=res.resource_link)}}"
                    {% else %}
                        href="{{res.resource_link}}"
                    {% endif %}>
                        <div class="row">
                                <div class="col-1" style="padding-top:2px; padding-left: 14px; padding-right:5px">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-card-text" viewBox="0 0 16 16">
                                          <path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h13zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13z"/>
                                          <path d="M3 5.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 8zm0 2.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5z"/>
                                    </svg>
                                 </div>
                                <div class="col-10" style="padding-right: 6px">
                                    <dd class="text-center font-weight-bold" style="margin-top: 2.5px!important; margin-bottom: 4px!important;">View Resource</dd>
                                </div>

                                </div>
                    </a>
                </div>

                {#{% for author in authors %}
                    {% if (author.username == current_user.username) %}
                    <p id="abcEdit"><strong>Edit Page: </strong>
                        <button class="badge rounded-pill bg-other-tag" id="editButton" onclick="editButtonFunc()">
                                Edit Page
                        </button>
                        <button class="badge rounded-pill bg-other-tag" id="saveButton" onclick='saveButtonFunc()' hidden>
                                Save
                        </button>
                    </p>
                    <p id="abcDelete"><strong>Delete Resource: </strong>
                        <button type="button" class="badge rounded-pill bg-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            Delete
                        </button>
                    </p>
                    <!-- Delete Modal -->
                    <div class="modal fade" id="deleteModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="deleteModalLabel">Delete Resource</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    Are you sure you want to delete this resource
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                                    <a href="{{url_for('resource')}}" class="btn btn-primary">Yes</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% endif %}
                {% endfor %}#}
            </div>
        </div>
    </div>
    <div class="row p-3" style = "padding-top: 0rem!important;">

            <p class="h4 card-title" id="resTitle">{{res.title}}</p>
            <div class="d-flex" style="padding-top: 0.5rem!important;">
                <p><strong> Created on:</strong></p>
                <p style="margin-right: 2rem!important;"> {{ res.created_at }}</p>
                <p><strong>Rating&nbsp;&nbsp;</strong></p>
{#                <img onclick="upvote()" src="{{url_for('static', filename='img/up.png')}}" , alt="Down" , width="20" , height="20">#}
                 <svg xmlns="http://www.w3.org/2000/svg" id = "up_1" width="20" height="20" fill="grey" class="bi bi-arrow-up-circle-fill" viewBox="0 0 16 16" onclick="upvote();
                            highlight(this, true)">
                    <path d="M16 8A8 8 0 1 0 0 8a8 8 0 0 0 16 0zm-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5z"
                    />
                 </svg>

                <p class="card-text px-3" id="upvoteCount">{{res.upvote_count}}</p>
{#                <img onclick="downvote()" src="{{url_for('static', filename='img/down.png')}}" , alt="Down" , width="20" , height="20">#}
                <svg xmlns="http://www.w3.org/2000/svg" id = "down_1" width="20" height="20" fill="grey" class="bi bi-arrow-down-circle-fill" viewBox="0 0 16 16" onclick="downvote();
                            highlight(this, false)">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V4.5z"
                    />
                </svg>

                <p class="card-text px-3" id="downvoteCount">{{res.downvote_count}}</p>
            </div>
            <p><strong>Visibility:&nbsp;</strong>
                {% if res.is_public %}
                    Public
                {% else %}
                    Private
                {% endif %}
            </p>
            <div class="row">
            <p><strong>Tags:&nbsp;&nbsp;</strong>
                {% for tag in resource_tags %}
                <span class="badge rounded-pill bg-other-tag">
                    {{enum_to_website_output(tag)}}
                </span>
                {% endfor %}
                {% if resource_tags | length == 0 %}
                    No additional tags
                {% endif %}
            </p>
            </div>
    </div>
    <div class="row p-3">
        <div class="card shadow" style="border-radius: 15px">
            <p class="h4 card-title">Description</p>
            <div class="card-body">
                <p id="resDesc">{{res.description}}</p>
                <hr class="px-3">
            </div>
            <p class="h4 card-title">Author</p>
            <div class="row">
                {% for author in authors %}
                <div class="col-1" align="center">
                    <img class="avatar" src="{{url_for('static',filename=author.avatar_link)}}" , alt="Profile Icon">
                </div>
                <div class="col-2">
                    <div class="row">
                        <p class="h6"><strong>{{author.username}}</strong></p>
                    </div>
                    <div class="row">
                        <p><small>{{author.email}}</small></p>
                    </div>
                </div>
                {% endfor %}
        </div>
    </div>
    <div class="row p-3">
        <div class="card shadow" style="border-radius: 15px">
            <div class="d-flex justify-content-between">
                <p class="h4 card-title">Comments</p>
                {% if current_user.is_authenticated %}
                <button class="badge rounded-pill bg-other-tag float-end" onclick='$("#newComment").attr("hidden",$("#newComment").is(":hidden") ? false : true) ;'>Post a comment</button>
                {% endif %}
            </div>
            {% if current_user.is_authenticated %}
            <div class="card-body" id="newComment" hidden>
                <div class="row" style="background-color: #fcebff;">
                    <hr>
                    <div class="col-1" align="center">
                        <img class="avatar" src="{{url_for('static',filename=current_user.avatar_link)}}" , alt="Profile Icon">
                    </div>
                    <div class="col">
                        <div class="row">
                            <p class="h6"><strong>{{current_user.username}}</strong></p>
                        </div>
                        <div class="row">
                            <textarea name="comment_text" class="form-control" id="comment_input" rows="4" style="background: rgb(255, 255, 255) none repeat scroll 0% 0%; height: 16px;" placeholder="Leave a comment"></textarea>
                            <div class = "d-flex justify-content-end">
                                <input type="submit" form="comment_form" value="Post Comment" class="btn btn-primary btn-sm" style="margin-right: 1rem!important;" onclick='addComment()'></input>
                                <button type="Button" class="btn btn-outline-primary btn-sm" onclick='document.getElementById("comment_input").value = "";'>Clear</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            <div id="result">
            </div>
        </div>
    </div>
</div>
    <script>
function highlight(image, bool) { //Changes what button is currently active or not

    if (bool) { //If we clicked a upvote
        $(image).toggleClass("clickedUp") //Toggle it
        var x = document.getElementById("down_1")
        $(x).removeClass("clickedDown") //Remove any colour on the downvote
    } else { //Downvote
         $(image).toggleClass("clickedDown") //Toggle it
        var y = document.getElementById("up_1")
        $(y).removeClass("clickedUp") //Remove any colour on the upvote
    }
}
</script>
{% endblock %}
